<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Polling - 디스플레이</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="display-body">
    <!-- 슬라이드 컨테이너 -->
    <div class="slides-container" id="slidesContainer">
        <!-- 질문 1 -->
        <div class="slide" data-question-id="1">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #2c3e50;">오늘 가장 기억에 남는 순간은?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> 답변
                    </div>
                </header>

                <div class="main-content">
                    <div class="answers-main">
                        <div class="question-core" data-question-index="01">
                            <span class="core-label">Question 01</span>
                            <p class="question-core-text"></p>
                        </div>

                        <div class="word-cloud" id="wordCloud1">
                            <p class="word-cloud-placeholder">답변이 모이면 핵심 키워드를 분석해 보여줄게요</p>
                        </div>

                        <div class="bubble-layer" id="bubbleLayer1">
                            <div class="bubble-placeholder">
                                <p>아직 답변이 없습니다</p>
                                <small>첫 번째 의견을 올려보세요!</small>
                            </div>
                        </div>
                    </div>

                    <aside class="info-panel">
                        <span class="live-chip">LIVE</span>
                        <p class="info-heading">모바일로 참여하세요</p>
                        <div class="qr-panel">
                            <div class="qr-frame">
                                <div class="qrcode" id="qrcode1"></div>
                            </div>
                            <p class="qr-instruction">카메라로 QR을 스캔하거나<br>접속 링크를 입력하세요</p>
                        </div>
                        <div class="info-meta">
                            <div class="meta-card">
                                <span class="meta-label">누적 답변</span>
                                <span class="meta-value answer-total">0</span>
                            </div>
                            <div class="meta-card">
                                <span class="meta-label">업데이트</span>
                                <span class="meta-value last-updated">-</span>
                            </div>
                        </div>
                        <div class="keyword-legend" id="keywordLegend1">
                            <p class="legend-placeholder">핵심 키워드가 여기에 표시됩니다</p>
                        </div>
                    </aside>
                </div>
            </div>

            <!-- 슬라이드 인디케이터 -->
            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">‹</button>
                <div class="slide-dots">
                    <span class="dot active" onclick="goToSlide(0)"></span>
                    <span class="dot" onclick="goToSlide(1)"></span>
                    <span class="dot" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">›</button>
            </div>
        </div>

        <!-- 질문 2 -->
        <div class="slide" data-question-id="2">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #2c3e50;">이 자리에서 배운 것 한 가지는?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> 답변
                    </div>
                </header>

                <div class="main-content">
                    <div class="answers-main">
                        <div class="question-core" data-question-index="02">
                            <span class="core-label">Question 02</span>
                            <p class="question-core-text"></p>
                        </div>

                        <div class="word-cloud" id="wordCloud2">
                            <p class="word-cloud-placeholder">답변이 모이면 핵심 키워드를 분석해 보여줄게요</p>
                        </div>

                        <div class="bubble-layer" id="bubbleLayer2">
                            <div class="bubble-placeholder">
                                <p>아직 답변이 없습니다</p>
                                <small>첫 번째 의견을 올려보세요!</small>
                            </div>
                        </div>
                    </div>

                    <aside class="info-panel">
                        <span class="live-chip">LIVE</span>
                        <p class="info-heading">모바일로 참여하세요</p>
                        <div class="qr-panel">
                            <div class="qr-frame">
                                <div class="qrcode" id="qrcode2"></div>
                            </div>
                            <p class="qr-instruction">카메라로 QR을 스캔하거나<br>접속 링크를 입력하세요</p>
                        </div>
                        <div class="info-meta">
                            <div class="meta-card">
                                <span class="meta-label">누적 답변</span>
                                <span class="meta-value answer-total">0</span>
                            </div>
                            <div class="meta-card">
                                <span class="meta-label">업데이트</span>
                                <span class="meta-value last-updated">-</span>
                            </div>
                        </div>
                        <div class="keyword-legend" id="keywordLegend2">
                            <p class="legend-placeholder">핵심 키워드가 여기에 표시됩니다</p>
                        </div>
                    </aside>
                </div>
            </div>

            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">‹</button>
                <div class="slide-dots">
                    <span class="dot" onclick="goToSlide(0)"></span>
                    <span class="dot active" onclick="goToSlide(1)"></span>
                    <span class="dot" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">›</button>
            </div>
        </div>

        <!-- 질문 3 -->
        <div class="slide" data-question-id="3">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #2c3e50;">한 단어로 오늘을 표현한다면?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> 답변
                    </div>
                </header>

                <div class="main-content">
                    <div class="answers-main">
                        <div class="question-core" data-question-index="03">
                            <span class="core-label">Question 03</span>
                            <p class="question-core-text"></p>
                        </div>

                        <div class="word-cloud" id="wordCloud3">
                            <p class="word-cloud-placeholder">답변이 모이면 핵심 키워드를 분석해 보여줄게요</p>
                        </div>

                        <div class="bubble-layer" id="bubbleLayer3">
                            <div class="bubble-placeholder">
                                <p>아직 답변이 없습니다</p>
                                <small>첫 번째 의견을 올려보세요!</small>
                            </div>
                        </div>
                    </div>

                    <aside class="info-panel">
                        <span class="live-chip">LIVE</span>
                        <p class="info-heading">모바일로 참여하세요</p>
                        <div class="qr-panel">
                            <div class="qr-frame">
                                <div class="qrcode" id="qrcode3"></div>
                            </div>
                            <p class="qr-instruction">카메라로 QR을 스캔하거나<br>접속 링크를 입력하세요</p>
                        </div>
                        <div class="info-meta">
                            <div class="meta-card">
                                <span class="meta-label">누적 답변</span>
                                <span class="meta-value answer-total">0</span>
                            </div>
                            <div class="meta-card">
                                <span class="meta-label">업데이트</span>
                                <span class="meta-value last-updated">-</span>
                            </div>
                        </div>
                        <div class="keyword-legend" id="keywordLegend3">
                            <p class="legend-placeholder">핵심 키워드가 여기에 표시됩니다</p>
                        </div>
                    </aside>
                </div>
            </div>

            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">‹</button>
                <div class="slide-dots">
                    <span class="dot" onclick="goToSlide(0)"></span>
                    <span class="dot" onclick="goToSlide(1)"></span>
                    <span class="dot active" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">›</button>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        let currentSlide = 0;
        const totalSlides = 3;
        let pollingIntervals = [];
        let lastAnswerIds = { 1: new Set(), 2: new Set(), 3: new Set() };
        const boardState = {
            1: { keywords: [], keywordColors: {} },
            2: { keywords: [], keywordColors: {} },
            3: { keywords: [], keywordColors: {} }
        };

        const CLUSTER_COLORS = ['cluster-blue', 'cluster-teal', 'cluster-gold', 'cluster-coral'];
        const TEXT_SIZES = ['text-size-xs', 'text-size-sm', 'text-size-md', 'text-size-lg'];
        const driftIntervals = {};

        const STOP_WORDS = new Set([
            'the','and','that','with','this','from','about','have','today','just','really','very','있어요','합니다','정말',
            '오늘','우리','그리고','그냥','하는','했다','있다','합니다','너무','진짜','뭔가','뭐가','어때','같아요','어떤','것','거','있는','해서','하면'
        ]);

        // 슬라이드 네비게이션
        function goToSlide(index) {
            currentSlide = index;
            const container = document.getElementById('slidesContainer');
            container.style.transform = `translateX(-${index * 100}vw)`;

            // 모든 dot 업데이트
            document.querySelectorAll('.slide-dots').forEach(dotsContainer => {
                dotsContainer.querySelectorAll('.dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
            });
        }

        function nextSlide() {
            goToSlide((currentSlide + 1) % totalSlides);
        }

        function prevSlide() {
            goToSlide((currentSlide - 1 + totalSlides) % totalSlides);
        }

        // 키보드 네비게이션
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevSlide();
            if (e.key === 'ArrowRight') nextSlide();
        });

        // 터치 스와이프
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) nextSlide();
            if (touchEndX > touchStartX + 50) prevSlide();
        }

        // QR 코드 생성
        function generateQRCodes() {
            const colors = ['#667eea', '#f093fb', '#4facfe'];

            QUESTIONS.forEach((question, index) => {
                const qrId = `qrcode${question.id}`;
                const answerUrl = `${window.location.origin}${window.location.pathname.replace('display.html', 'answer.html')}?q=${question.id}`;

                new QRCode(document.getElementById(qrId), {
                    text: answerUrl,
                    width: 200,
                    height: 200,
                    colorDark: colors[index],
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            });
        }

        // 답변 로드
        async function loadAnswers(questionId) {
            const result = await getAnswers(questionId, 100);

            if (!result.success || !result.data) return;

            const container = document.getElementById(`bubbleLayer${questionId}`);
            const slide = document.querySelector(`.slide[data-question-id="${questionId}"]`);
            if (!container || !slide) return;

            const countElement = slide.querySelector('.answer-count');
            const totalElement = slide.querySelector('.answer-total');
            const updatedElement = slide.querySelector('.last-updated');

            const responseCount = result.data.length;
            const nowText = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

            if (countElement) countElement.textContent = responseCount;
            if (totalElement) totalElement.textContent = responseCount;
            if (updatedElement) updatedElement.textContent = nowText;

            if (responseCount === 0) {
                container.innerHTML = `
                    <div class="bubble-placeholder">
                        <p>아직 답변이 없습니다</p>
                        <small>첫 번째 의견을 올려보세요!</small>
                    </div>
                `;
                boardState[questionId].keywords = [];
                boardState[questionId].keywordColors = {};
                lastAnswerIds[questionId].clear();
                if (driftIntervals[questionId]) {
                    clearInterval(driftIntervals[questionId]);
                    delete driftIntervals[questionId];
                }
                updateKeywordVisuals(questionId, []);
                return;
            }

            updateKeywordVisuals(questionId, result.data);

            const newAnswers = result.data.filter(answer => !lastAnswerIds[questionId].has(answer.id));

            if (newAnswers.length > 0) {
                const placeholder = container.querySelector('.bubble-placeholder');
                if (placeholder) placeholder.remove();

                newAnswers.forEach((answer, index) => {
                    lastAnswerIds[questionId].add(answer.id);
                    setTimeout(() => {
                        addAnswerText(container, answer, questionId);
                    }, index * 120);
                });

                setTimeout(() => {
                    driftExistingAnswers(questionId);
                    ensureDriftLoop(questionId);
                }, newAnswers.length * 140);
            }
        }

        // 답변 텍스트 추가 및 드리프트
        function addAnswerText(container, answer, questionId) {
            const textEl = document.createElement('span');
            textEl.className = 'answer-text';
            textEl.setAttribute('data-answer-id', answer.id);

            const sizeClass = TEXT_SIZES[Math.floor(Math.random() * TEXT_SIZES.length)];
            textEl.classList.add(sizeClass);

            if (Math.random() < 0.1) {
                textEl.classList.add('vertical');
            }

            const keywords = boardState[questionId]?.keywords || [];
            const clusterInfo = resolveClusterInfo(answer.answer_text, questionId, keywords);
            textEl.classList.add(clusterInfo.colorClass);
            textEl.textContent = answer.answer_text;

            textEl.style.setProperty('--offset-x', '0px');
            textEl.style.setProperty('--offset-y', '0px');
            textEl.style.setProperty('--rotation', '0deg');

            container.appendChild(textEl);

            requestAnimationFrame(() => {
                textEl.classList.add('show');
                assignRandomOffset(textEl, container);
            });

            enforceTextLimit(container);
        }

        function assignRandomOffset(element, container) {
            const width = container.clientWidth || 0;
            const height = container.clientHeight || 0;
            if (!width || !height) return;

            const padding = 80;
            const offsetX = (Math.random() * 2 - 1) * ((width / 2) - padding);
            const offsetY = (Math.random() * 2 - 1) * ((height / 2) - padding);
            const rotation = (Math.random() * 8 - 4).toFixed(2);

            element.style.setProperty('--offset-x', `${offsetX}px`);
            element.style.setProperty('--offset-y', `${offsetY}px`);
            element.style.setProperty('--rotation', `${rotation}deg`);
        }

        function driftExistingAnswers(questionId) {
            const container = document.getElementById(`bubbleLayer${questionId}`);
            if (!container) return;
            const texts = container.querySelectorAll('.answer-text');
            texts.forEach(text => assignRandomOffset(text, container));
        }

        function ensureDriftLoop(questionId) {
            if (driftIntervals[questionId]) return;
            driftIntervals[questionId] = setInterval(() => {
                driftExistingAnswers(questionId);
            }, 7000);
        }

        function enforceTextLimit(container, limit = 80) {
            const items = Array.from(container.querySelectorAll('.answer-text'));
            if (items.length <= limit) return;
            items.slice(limit).forEach(item => item.remove());
        }

        function updateKeywordVisuals(questionId, answers) {
            boardState[questionId] = boardState[questionId] || { keywords: [], keywordColors: {} };
            const keywords = extractTopKeywords(answers);
            boardState[questionId].keywords = keywords;
            renderKeywordLegend(questionId, keywords);
            renderWordCloud(questionId, keywords);
        }

        function extractTopKeywords(answers) {
            const frequency = new Map();

            answers.forEach(answer => {
                const cleaned = answer?.answer_text?.toLowerCase()?.replace(/[^0-9a-z\s가-힣]/g, ' ') || '';
                cleaned.split(/\s+/)
                    .filter(Boolean)
                    .forEach(word => {
                        const trimmed = word.trim();
                        if (trimmed.length < 2 || STOP_WORDS.has(trimmed) || /^\d+$/.test(trimmed)) return;
                        frequency.set(trimmed, (frequency.get(trimmed) || 0) + 1);
                    });
            });

            return Array.from(frequency.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6)
                .map(([word, count]) => ({ word, count }));
        }

        function renderKeywordLegend(questionId, keywords) {
            const legend = document.getElementById(`keywordLegend${questionId}`);
            if (!legend) return;

            if (!keywords.length) {
                legend.innerHTML = '<p class="legend-placeholder">핵심 키워드가 여기에 표시됩니다</p>';
                boardState[questionId].keywordColors = {};
                return;
            }

            legend.innerHTML = '';
            const colorMap = {};

            keywords.forEach((item, index) => {
                const colorClass = CLUSTER_COLORS[index % CLUSTER_COLORS.length];
                colorMap[item.word] = colorClass;

                const chip = document.createElement('div');
                chip.className = `keyword-chip ${colorClass}`;
                chip.innerHTML = `
                    <span>${item.word}</span>
                    <strong>${item.count}</strong>
                `;
                legend.appendChild(chip);
            });

            boardState[questionId].keywordColors = colorMap;
        }

        function renderWordCloud(questionId, keywords) {
            const container = document.getElementById(`wordCloud${questionId}`);
            if (!container) return;

            if (!keywords.length) {
                container.innerHTML = '<p class="word-cloud-placeholder">답변이 모이면 핵심 키워드를 분석해 보여줄게요</p>';
                return;
            }

            container.innerHTML = '';
            const maxCount = keywords[0]?.count || 1;

            keywords.forEach((item, index) => {
                const wordEl = document.createElement('span');
                const scale = 0.9 + (item.count / maxCount) * 1.2;
                const colorClass = CLUSTER_COLORS[index % CLUSTER_COLORS.length];
                wordEl.className = `cloud-word ${colorClass}`;
                wordEl.style.setProperty('--scale', scale.toFixed(2));
                wordEl.textContent = item.word;
                container.appendChild(wordEl);
            });
        }

        function resolveClusterInfo(text, questionId, keywords) {
            const normalized = (text || '').toLowerCase();
            const colorMap = boardState[questionId]?.keywordColors || {};
            let matchedWord = '';

            for (const keyword of keywords) {
                if (normalized.includes(keyword.word)) {
                    matchedWord = keyword.word;
                    break;
                }
            }

            const colorClass = matchedWord && colorMap[matchedWord]
                ? colorMap[matchedWord]
                : CLUSTER_COLORS[Math.floor(Math.random() * CLUSTER_COLORS.length)];

            const label = matchedWord ? `#${matchedWord}` : 'Fresh idea';

            return { colorClass, label };
        }

        // 질문 텍스트를 중앙 코어에 동기화
        function syncQuestionCores() {
            document.querySelectorAll('.slide').forEach(slide => {
                const questionText = slide.querySelector('.display-question')?.textContent?.trim();
                const coreText = slide.querySelector('.question-core-text');

                if (questionText && coreText) {
                    coreText.textContent = questionText;
                }
            });
        }

        // 모든 질문 polling 시작
        function startPolling() {
            [1, 2, 3].forEach(questionId => {
                // 즉시 로드
                loadAnswers(questionId);

                // 2초마다 polling
                const interval = setInterval(() => loadAnswers(questionId), 2000);
                pollingIntervals.push(interval);
            });
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            syncQuestionCores();
            generateQRCodes();
            startPolling();
        });
    </script>
</body>
</html>
