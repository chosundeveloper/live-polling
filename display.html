<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Polling - ë””ìŠ¤í”Œë ˆì´</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="display-body">
    <!-- ìŠ¬ë¼ì´ë“œ ì»¨í…Œì´ë„ˆ -->
    <div class="slides-container" id="slidesContainer">
        <!-- ì§ˆë¬¸ 1 -->
        <div class="slide" data-question-id="1">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #2c3e50;">ì˜¤ëŠ˜ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì€?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> ë‹µë³€
                    </div>
                </header>

                <div class="main-content">
                    <aside class="qr-sidebar">
                        <div class="qr-container">
                            <div class="qrcode" id="qrcode1"></div>
                        </div>
                        <p class="qr-instruction">ğŸ“± ìŠ¤ìº”í•˜ì—¬<br>ë‹µë³€í•˜ì„¸ìš”</p>
                    </aside>

                    <div class="answers-main">
                        <div class="answers-grid" id="answersGrid1">
                            <p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤<br><small>QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”!</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìŠ¬ë¼ì´ë“œ ì¸ë””ì¼€ì´í„° -->
            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">â€¹</button>
                <div class="slide-dots">
                    <span class="dot active" onclick="goToSlide(0)"></span>
                    <span class="dot" onclick="goToSlide(1)"></span>
                    <span class="dot" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">â€º</button>
            </div>
        </div>

        <!-- ì§ˆë¬¸ 2 -->
        <div class="slide" data-question-id="2">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #2c3e50;">ì´ ìë¦¬ì—ì„œ ë°°ìš´ ê²ƒ í•œ ê°€ì§€ëŠ”?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> ë‹µë³€
                    </div>
                </header>

                <div class="main-content">
                    <aside class="qr-sidebar">
                        <div class="qr-container">
                            <div class="qrcode" id="qrcode2"></div>
                        </div>
                        <p class="qr-instruction">ğŸ“± ìŠ¤ìº”í•˜ì—¬<br>ë‹µë³€í•˜ì„¸ìš”</p>
                    </aside>

                    <div class="answers-main">
                        <div class="answers-grid" id="answersGrid2">
                            <p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤<br><small>QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”!</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">â€¹</button>
                <div class="slide-dots">
                    <span class="dot" onclick="goToSlide(0)"></span>
                    <span class="dot active" onclick="goToSlide(1)"></span>
                    <span class="dot" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">â€º</button>
            </div>
        </div>

        <!-- ì§ˆë¬¸ 3 -->
        <div class="slide" data-question-id="3">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #2c3e50;">í•œ ë‹¨ì–´ë¡œ ì˜¤ëŠ˜ì„ í‘œí˜„í•œë‹¤ë©´?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> ë‹µë³€
                    </div>
                </header>

                <div class="main-content">
                    <aside class="qr-sidebar">
                        <div class="qr-container">
                            <div class="qrcode" id="qrcode3"></div>
                        </div>
                        <p class="qr-instruction">ğŸ“± ìŠ¤ìº”í•˜ì—¬<br>ë‹µë³€í•˜ì„¸ìš”</p>
                    </aside>

                    <div class="answers-main">
                        <div class="answers-grid" id="answersGrid3">
                            <p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤<br><small>QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”!</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">â€¹</button>
                <div class="slide-dots">
                    <span class="dot" onclick="goToSlide(0)"></span>
                    <span class="dot" onclick="goToSlide(1)"></span>
                    <span class="dot active" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">â€º</button>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        let currentSlide = 0;
        const totalSlides = 3;
        let pollingIntervals = [];
        let lastAnswerIds = { 1: new Set(), 2: new Set(), 3: new Set() };

        // ìŠ¬ë¼ì´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        function goToSlide(index) {
            currentSlide = index;
            const container = document.getElementById('slidesContainer');
            container.style.transform = `translateX(-${index * 100}vw)`;

            // ëª¨ë“  dot ì—…ë°ì´íŠ¸
            document.querySelectorAll('.slide-dots').forEach(dotsContainer => {
                dotsContainer.querySelectorAll('.dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
            });
        }

        function nextSlide() {
            goToSlide((currentSlide + 1) % totalSlides);
        }

        function prevSlide() {
            goToSlide((currentSlide - 1 + totalSlides) % totalSlides);
        }

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevSlide();
            if (e.key === 'ArrowRight') nextSlide();
        });

        // í„°ì¹˜ ìŠ¤ì™€ì´í”„
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) nextSlide();
            if (touchEndX > touchStartX + 50) prevSlide();
        }

        // QR ì½”ë“œ ìƒì„±
        function generateQRCodes() {
            const colors = ['#667eea', '#f093fb', '#4facfe'];

            QUESTIONS.forEach((question, index) => {
                const qrId = `qrcode${question.id}`;
                const answerUrl = `${window.location.origin}${window.location.pathname.replace('display.html', 'answer.html')}?q=${question.id}`;

                new QRCode(document.getElementById(qrId), {
                    text: answerUrl,
                    width: 200,
                    height: 200,
                    colorDark: colors[index],
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            });
        }

        // ë‹µë³€ ë¡œë“œ
        async function loadAnswers(questionId) {
            const result = await getAnswers(questionId, 100);

            if (result.success && result.data) {
                const container = document.getElementById(`answersGrid${questionId}`);
                const countElement = document.querySelectorAll('.slide')[questionId - 1].querySelector('.answer-count');

                countElement.textContent = result.data.length;

                // ìƒˆë¡œìš´ ë‹µë³€ë§Œ ì¶”ê°€
                const newAnswers = result.data.filter(answer => !lastAnswerIds[questionId].has(answer.id));

                if (newAnswers.length > 0) {
                    // placeholder ì œê±°
                    const placeholder = container.querySelector('.placeholder');
                    if (placeholder) placeholder.remove();

                    newAnswers.forEach((answer, index) => {
                        lastAnswerIds[questionId].add(answer.id);
                        setTimeout(() => {
                            addAnswerCard(container, answer, questionId);
                        }, index * 100); // ìˆœì°¨ì ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜
                    });
                }
            }
        }

        // ë‹µë³€ ì¹´ë“œ ì¶”ê°€
        function addAnswerCard(container, answer, questionId) {
            const card = document.createElement('div');
            card.className = 'answer-card';
            card.setAttribute('data-answer-id', answer.id);

            const colors = ['#667eea', '#f093fb', '#4facfe'];
            const color = colors[questionId - 1];

            card.style.background = `linear-gradient(135deg, ${color} 0%, ${adjustColor(color, -20)} 100%)`;

            card.innerHTML = `
                <div class="answer-card-text">${escapeHtml(answer.answer_text)}</div>
            `;

            // ë§¨ ì•ì— ì¶”ê°€ (ìµœì‹ ì´ ìœ„ë¡œ)
            container.insertBefore(card, container.firstChild);

            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            setTimeout(() => {
                card.classList.add('show');
            }, 10);
        }

        // ìƒ‰ìƒ ì¡°ì • í•¨ìˆ˜
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ëª¨ë“  ì§ˆë¬¸ polling ì‹œì‘
        function startPolling() {
            [1, 2, 3].forEach(questionId => {
                // ì¦‰ì‹œ ë¡œë“œ
                loadAnswers(questionId);

                // 2ì´ˆë§ˆë‹¤ polling
                const interval = setInterval(() => loadAnswers(questionId), 2000);
                pollingIntervals.push(interval);
            });
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            generateQRCodes();
            startPolling();
        });
    </script>
</body>
</html>
