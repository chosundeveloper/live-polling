<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Polling - ë””ìŠ¤í”Œë ˆì´</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="display-body">
    <!-- ìŠ¬ë¼ì´ë“œ ì»¨í…Œì´ë„ˆ -->
    <div class="slides-container" id="slidesContainer">
        <!-- ì§ˆë¬¸ 1 -->
        <div class="slide" data-question-id="1">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #667eea;">ì˜¤ëŠ˜ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì€?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> ë‹µë³€
                    </div>
                </header>

                <div class="qr-section">
                    <div class="qr-container">
                        <div class="qrcode" id="qrcode1"></div>
                    </div>
                    <p class="qr-instruction">ğŸ“± QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”!</p>
                </div>

                <div class="answers-section">
                    <div class="answers-flow" id="answersFlow1">
                        <p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- ìŠ¬ë¼ì´ë“œ ì¸ë””ì¼€ì´í„° -->
            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">â€¹</button>
                <div class="slide-dots">
                    <span class="dot active" onclick="goToSlide(0)"></span>
                    <span class="dot" onclick="goToSlide(1)"></span>
                    <span class="dot" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">â€º</button>
            </div>
        </div>

        <!-- ì§ˆë¬¸ 2 -->
        <div class="slide" data-question-id="2">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #f093fb;">ì´ ìë¦¬ì—ì„œ ë°°ìš´ ê²ƒ í•œ ê°€ì§€ëŠ”?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> ë‹µë³€
                    </div>
                </header>

                <div class="qr-section">
                    <div class="qr-container">
                        <div class="qrcode" id="qrcode2"></div>
                    </div>
                    <p class="qr-instruction">ğŸ“± QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”!</p>
                </div>

                <div class="answers-section">
                    <div class="answers-flow" id="answersFlow2">
                        <p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">â€¹</button>
                <div class="slide-dots">
                    <span class="dot" onclick="goToSlide(0)"></span>
                    <span class="dot active" onclick="goToSlide(1)"></span>
                    <span class="dot" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">â€º</button>
            </div>
        </div>

        <!-- ì§ˆë¬¸ 3 -->
        <div class="slide" data-question-id="3">
            <div class="slide-content">
                <header class="display-header">
                    <h1 class="display-question" style="color: #4facfe;">í•œ ë‹¨ì–´ë¡œ ì˜¤ëŠ˜ì„ í‘œí˜„í•œë‹¤ë©´?</h1>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="answer-count">0</span> ë‹µë³€
                    </div>
                </header>

                <div class="qr-section">
                    <div class="qr-container">
                        <div class="qrcode" id="qrcode3"></div>
                    </div>
                    <p class="qr-instruction">ğŸ“± QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”!</p>
                </div>

                <div class="answers-section">
                    <div class="answers-flow" id="answersFlow3">
                        <p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <div class="slide-nav">
                <button class="nav-btn prev-btn" onclick="prevSlide()">â€¹</button>
                <div class="slide-dots">
                    <span class="dot" onclick="goToSlide(0)"></span>
                    <span class="dot" onclick="goToSlide(1)"></span>
                    <span class="dot active" onclick="goToSlide(2)"></span>
                </div>
                <button class="nav-btn next-btn" onclick="nextSlide()">â€º</button>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        let currentSlide = 0;
        const totalSlides = 3;
        let pollingIntervals = [];
        let lastAnswerIds = { 1: new Set(), 2: new Set(), 3: new Set() };

        // ìŠ¬ë¼ì´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        function goToSlide(index) {
            currentSlide = index;
            const container = document.getElementById('slidesContainer');
            container.style.transform = `translateX(-${index * 100}vw)`;

            // ëª¨ë“  dot ì—…ë°ì´íŠ¸
            document.querySelectorAll('.slide-dots').forEach(dotsContainer => {
                dotsContainer.querySelectorAll('.dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
            });
        }

        function nextSlide() {
            goToSlide((currentSlide + 1) % totalSlides);
        }

        function prevSlide() {
            goToSlide((currentSlide - 1 + totalSlides) % totalSlides);
        }

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevSlide();
            if (e.key === 'ArrowRight') nextSlide();
        });

        // í„°ì¹˜ ìŠ¤ì™€ì´í”„
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) nextSlide();
            if (touchEndX > touchStartX + 50) prevSlide();
        }

        // QR ì½”ë“œ ìƒì„±
        function generateQRCodes() {
            const colors = ['#667eea', '#f093fb', '#4facfe'];

            QUESTIONS.forEach((question, index) => {
                const qrId = `qrcode${question.id}`;
                const answerUrl = `${window.location.origin}${window.location.pathname.replace('display.html', 'answer.html')}?q=${question.id}`;

                new QRCode(document.getElementById(qrId), {
                    text: answerUrl,
                    width: 200,
                    height: 200,
                    colorDark: colors[index],
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            });
        }

        // ë‹µë³€ ë¡œë“œ
        async function loadAnswers(questionId) {
            const result = await getAnswers(questionId, 100);

            if (result.success && result.data) {
                const container = document.getElementById(`answersFlow${questionId}`);
                const countElement = document.querySelectorAll('.slide')[questionId - 1].querySelector('.answer-count');

                countElement.textContent = result.data.length;

                // ìƒˆë¡œìš´ ë‹µë³€ë§Œ ì¶”ê°€
                const newAnswers = result.data.filter(answer => !lastAnswerIds[questionId].has(answer.id));

                if (newAnswers.length > 0) {
                    // placeholder ì œê±°
                    const placeholder = container.querySelector('.placeholder');
                    if (placeholder) placeholder.remove();

                    newAnswers.forEach(answer => {
                        lastAnswerIds[questionId].add(answer.id);
                        addAnswerWithAnimation(container, answer);
                    });
                }
            }
        }

        // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ë‹µë³€ ì¶”ê°€
        function addAnswerWithAnimation(container, answer) {
            const bubble = document.createElement('div');
            bubble.className = 'answer-bubble';
            bubble.innerHTML = `
                <div class="bubble-text">${escapeHtml(answer.answer_text)}</div>
                <div class="bubble-time">${formatTime(answer.created_at)}</div>
            `;

            // ëœë¤ ìœ„ì¹˜ì—ì„œ ì‹œì‘
            const startX = Math.random() * 80 + 10; // 10-90%
            bubble.style.left = `${startX}%`;

            container.appendChild(bubble);

            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            setTimeout(() => {
                bubble.classList.add('show');
            }, 10);

            // 10ì´ˆ í›„ í˜ì´ë“œì•„ì›ƒ
            setTimeout(() => {
                bubble.classList.add('fade-out');
                setTimeout(() => bubble.remove(), 1000);
            }, 10000);
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ëª¨ë“  ì§ˆë¬¸ polling ì‹œì‘
        function startPolling() {
            [1, 2, 3].forEach(questionId => {
                // ì¦‰ì‹œ ë¡œë“œ
                loadAnswers(questionId);

                // 2ì´ˆë§ˆë‹¤ polling
                const interval = setInterval(() => loadAnswers(questionId), 2000);
                pollingIntervals.push(interval);
            });
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            generateQRCodes();
            startPolling();
        });
    </script>
</body>
</html>
