<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë””ìŠ¤í”Œë ˆì´ í™”ë©´</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="display-body">
    <div class="display-container">
        <!-- í—¤ë” ì˜ì—­ -->
        <header class="display-header">
            <h1 id="questionText" class="display-question">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
            <div class="status-indicator">
                <span class="pulse"></span>
                <span id="answerCount">0</span> ë‹µë³€
            </div>
        </header>

        <!-- QR ì½”ë“œ ì˜ì—­ -->
        <div class="qr-section">
            <div class="qr-container">
                <div id="qrcode"></div>
            </div>
            <p class="qr-instruction">ğŸ“± QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”!</p>
        </div>

        <!-- ë‹µë³€ í‘œì‹œ ì˜ì—­ -->
        <div class="answers-section">
            <h2 class="section-title">ğŸ’¬ ì‹¤ì‹œê°„ ë‹µë³€</h2>
            <div id="answersContainer" class="answers-grid">
                <p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì„œ ì²« ë²ˆì§¸ ë‹µë³€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        class DisplayScreen {
            constructor() {
                this.questionId = this.getQuestionId();
                this.question = QUESTIONS.find(q => q.id === this.questionId);
                this.pollingInterval = null;
                this.answers = [];

                this.init();
            }

            getQuestionId() {
                const params = new URLSearchParams(window.location.search);
                return parseInt(params.get('q')) || 1;
            }

            init() {
                if (!this.question) {
                    alert('ì˜ëª»ëœ ì§ˆë¬¸ IDì…ë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }

                // ì§ˆë¬¸ í‘œì‹œ
                document.getElementById('questionText').textContent = this.question.question;
                document.getElementById('questionText').style.color = this.question.color;

                // QR ì½”ë“œ ìƒì„±
                this.generateQRCode();

                // ë‹µë³€ polling ì‹œì‘
                this.startPolling();

                // ì´ˆê¸° ë‹µë³€ ë¡œë“œ
                this.loadAnswers();
            }

            generateQRCode() {
                const answerUrl = `${window.location.origin}${window.location.pathname.replace('display.html', 'answer.html')}?q=${this.questionId}`;

                new QRCode(document.getElementById('qrcode'), {
                    text: answerUrl,
                    width: 256,
                    height: 256,
                    colorDark: this.question.color,
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            startPolling() {
                // 2ì´ˆë§ˆë‹¤ ìƒˆ ë‹µë³€ ì²´í¬
                this.pollingInterval = setInterval(() => {
                    this.loadAnswers();
                }, 2000);
            }

            async loadAnswers() {
                const result = await getAnswers(this.questionId, 50);

                if (result.success) {
                    this.answers = result.data;
                    this.displayAnswers();
                    this.updateCount();
                }
            }

            displayAnswers() {
                const container = document.getElementById('answersContainer');

                if (this.answers.length === 0) {
                    container.innerHTML = '<p class="placeholder">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì„œ ì²« ë²ˆì§¸ ë‹µë³€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>';
                    return;
                }

                container.innerHTML = this.answers.map((answer, index) => `
                    <div class="answer-card" style="animation-delay: ${index * 0.05}s;">
                        <div class="answer-text">${this.escapeHtml(answer.answer_text)}</div>
                        <div class="answer-time">${this.formatTime(answer.created_at)}</div>
                    </div>
                `).join('');
            }

            updateCount() {
                document.getElementById('answerCount').textContent = this.answers.length;
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000); // seconds

                if (diff < 60) return 'ë°©ê¸ˆ ì „';
                if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
                return date.toLocaleDateString('ko-KR');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new DisplayScreen();
        });
    </script>
</body>
</html>
