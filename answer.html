<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹µë³€í•˜ê¸°</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="answer-body">
    <div class="answer-container">
        <div class="answer-header">
            <h1>âœï¸ ë‹µë³€í•˜ê¸°</h1>
            <!-- íƒ€ì´ë¨¸ -->
            <div class="timer-container">
                <div class="timer-circle">
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <circle class="timer-bg" cx="50" cy="50" r="45"></circle>
                        <circle class="timer-progress" id="timerProgress" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <div class="timer-text" id="timerText">100</div>
                </div>
                <p class="timer-label">ë‚¨ì€ ì‹œê°„ (ì´ˆ)</p>
            </div>
        </div>

        <div class="question-display">
            <div class="question-label">ì§ˆë¬¸</div>
            <h2 id="questionText" class="question-text">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
        </div>

        <form id="answerForm" class="answer-form">
            <div class="form-group">
                <label for="answerInput">ë‹¹ì‹ ì˜ ë‹µë³€</label>
                <textarea
                    id="answerInput"
                    class="answer-input"
                    rows="5"
                    placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    required
                    maxlength="500"
                ></textarea>
                <div class="char-count">
                    <span id="charCount">0</span> / 500
                </div>
            </div>

            <button type="submit" class="btn btn-submit" id="submitBtn">
                ğŸ“¤ ë‹µë³€ ì œì¶œí•˜ê¸°
            </button>
        </form>

        <div id="successMessage" class="success-message" style="display: none;">
            <div class="success-icon">âœ…</div>
            <h3>ë‹µë³€ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
            <p>ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
            <button class="btn btn-secondary" onclick="resetForm()">ë‹¤ì‹œ ë‹µë³€í•˜ê¸°</button>
        </div>

        <div id="timeoutMessage" class="error-message" style="display: none;">
            <div class="error-icon">â±ï¸</div>
            <h3>ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
            <p>ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ ì‹œê°„(100ì´ˆ)ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-secondary" onclick="resetForm()">ë‹¤ì‹œ ì‹œë„í•˜ê¸°</button>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
            <div class="error-icon">âŒ</div>
            <h3>ì œì¶œ ì‹¤íŒ¨</h3>
            <p id="errorText">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-secondary" onclick="hideError()">í™•ì¸</button>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        class AnswerPage {
            constructor() {
                this.questionId = this.getQuestionId();
                this.question = QUESTIONS.find(q => q.id === this.questionId);

                this.form = document.getElementById('answerForm');
                this.input = document.getElementById('answerInput');
                this.submitBtn = document.getElementById('submitBtn');
                this.charCount = document.getElementById('charCount');

                // íƒ€ì´ë¨¸
                this.timeLeft = 100; // 100ì´ˆ
                this.timerInterval = null;
                this.timerProgress = document.getElementById('timerProgress');
                this.timerText = document.getElementById('timerText');

                this.init();
            }

            getQuestionId() {
                const params = new URLSearchParams(window.location.search);
                return parseInt(params.get('q')) || 1;
            }

            init() {
                if (!this.question) {
                    alert('ì˜ëª»ëœ ì§ˆë¬¸ IDì…ë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }

                // ì§ˆë¬¸ í‘œì‹œ
                const questionText = document.getElementById('questionText');
                questionText.textContent = this.question.question;
                questionText.style.color = this.question.color;

                // Placeholder ì„¤ì •
                this.input.placeholder = this.question.placeholder;

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                this.input.addEventListener('input', () => this.updateCharCount());
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));

                // íƒ€ì´ë¨¸ ì‹œì‘
                this.startTimer();
            }

            startTimer() {
                const circumference = 2 * Math.PI * 45; // r=45
                this.timerProgress.style.strokeDasharray = circumference;
                this.timerProgress.style.strokeDashoffset = 0;

                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimer();

                    if (this.timeLeft <= 0) {
                        this.handleTimeout();
                    }
                }, 1000);
            }

            updateTimer() {
                this.timerText.textContent = this.timeLeft;

                const circumference = 2 * Math.PI * 45;
                const offset = circumference * (1 - this.timeLeft / 100);
                this.timerProgress.style.strokeDashoffset = offset;

                // ìƒ‰ìƒ ë³€ê²½
                if (this.timeLeft <= 10) {
                    this.timerProgress.style.stroke = '#dc3545'; // ë¹¨ê°•
                    this.timerText.style.color = '#dc3545';
                } else if (this.timeLeft <= 30) {
                    this.timerProgress.style.stroke = '#ffc107'; // ë…¸ë‘
                    this.timerText.style.color = '#ffc107';
                }
            }

            handleTimeout() {
                clearInterval(this.timerInterval);
                this.form.style.display = 'none';
                document.querySelector('.question-display').style.display = 'none';
                document.querySelector('.timer-container').style.display = 'none';
                document.getElementById('timeoutMessage').style.display = 'block';
            }

            updateCharCount() {
                const length = this.input.value.length;
                this.charCount.textContent = length;

                if (length > 450) {
                    this.charCount.style.color = '#dc3545';
                } else {
                    this.charCount.style.color = '#6c757d';
                }
            }

            async handleSubmit(e) {
                e.preventDefault();

                const answerText = this.input.value.trim();

                if (!answerText) {
                    this.showError('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (answerText.length < 2) {
                    this.showError('ìµœì†Œ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // ë²„íŠ¼ ë¹„í™œì„±í™”
                this.submitBtn.disabled = true;
                this.submitBtn.textContent = 'ì œì¶œ ì¤‘...';

                // ë‹µë³€ ì œì¶œ
                const result = await submitAnswer(this.questionId, answerText);

                if (result.success) {
                    this.showSuccess();
                } else {
                    this.showError(result.error || 'ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    this.submitBtn.disabled = false;
                    this.submitBtn.textContent = 'ğŸ“¤ ë‹µë³€ ì œì¶œí•˜ê¸°';
                }
            }

            showSuccess() {
                clearInterval(this.timerInterval);
                this.form.style.display = 'none';
                document.querySelector('.question-display').style.display = 'none';
                document.querySelector('.timer-container').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
            }

            showError(message) {
                document.getElementById('errorText').textContent = message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        function resetForm() {
            location.reload();
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new AnswerPage();
        });
    </script>
</body>
</html>
